# 社区模块技术方案V1.0.0

## 一、架构设计

### 1.1 模块结构
- 新增模块：`xiaou-community`
- 依赖关系：`xiaou-community` → `xiaou-common`
- 用户信息获取：使用 `UserContextUtil` 统一工具类
- 模块解耦：不直接依赖其他业务模块

### 1.2 技术栈
- 框架：Spring Boot + MyBatis
- 数据库：MySQL
- 用户认证：通过 common 模块的 UserContextUtil
- 分页：使用 PageHelper.doPage()
- 对象转换：Hutool BeanUtil

## 二、数据库设计

### 2.1 帖子表 (community_post)
```sql
CREATE TABLE `community_post` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '帖子ID',
  `title` varchar(200) NOT NULL COMMENT '帖子标题',
  `content` text NOT NULL COMMENT '帖子内容',
  `category` varchar(50) DEFAULT NULL COMMENT '分类标签',
  `author_id` bigint NOT NULL COMMENT '作者用户ID',
  `author_name` varchar(50) NOT NULL COMMENT '作者用户名',
  `view_count` int DEFAULT 0 COMMENT '浏览次数',
  `like_count` int DEFAULT 0 COMMENT '点赞数',
  `comment_count` int DEFAULT 0 COMMENT '评论数',
  `collect_count` int DEFAULT 0 COMMENT '收藏数',
  `is_top` tinyint DEFAULT 0 COMMENT '是否置顶：0-否，1-是',
  `top_expire_time` datetime DEFAULT NULL COMMENT '置顶过期时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：1-正常，2-下架，3-删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_author_id` (`author_id`),
  KEY `idx_status_top_create` (`status`, `is_top`, `create_time`),
  KEY `idx_category` (`category`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='社区帖子表';
```

### 2.2 评论表 (community_comment)
```sql
CREATE TABLE `community_comment` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `post_id` bigint NOT NULL COMMENT '帖子ID',
  `parent_id` bigint DEFAULT 0 COMMENT '父评论ID，0表示顶级评论',
  `content` text NOT NULL COMMENT '评论内容',
  `author_id` bigint NOT NULL COMMENT '评论者用户ID',
  `author_name` varchar(50) NOT NULL COMMENT '评论者用户名',
  `like_count` int DEFAULT 0 COMMENT '点赞数',
  `status` tinyint DEFAULT 1 COMMENT '状态：1-正常，2-删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_author_id` (`author_id`),
  KEY `idx_status_create` (`status`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='社区评论表';
```

### 2.3 帖子点赞表 (community_post_like)
```sql
CREATE TABLE `community_post_like` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `post_id` bigint NOT NULL COMMENT '帖子ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `user_name` varchar(50) NOT NULL COMMENT '用户名',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '点赞时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_post_user` (`post_id`, `user_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='帖子点赞表';
```

### 2.4 评论点赞表 (community_comment_like)
```sql
CREATE TABLE `community_comment_like` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `comment_id` bigint NOT NULL COMMENT '评论ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `user_name` varchar(50) NOT NULL COMMENT '用户名',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '点赞时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_comment_user` (`comment_id`, `user_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论点赞表';
```

### 2.5 帖子收藏表 (community_post_collect)
```sql
CREATE TABLE `community_post_collect` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `post_id` bigint NOT NULL COMMENT '帖子ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `user_name` varchar(50) NOT NULL COMMENT '用户名',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_post_user` (`post_id`, `user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='帖子收藏表';
```

### 2.6 用户社区状态表 (community_user_status)
```sql
CREATE TABLE `community_user_status` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '状态ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `user_name` varchar(50) NOT NULL COMMENT '用户名',
  `is_banned` tinyint DEFAULT 0 COMMENT '是否封禁：0-否，1-是',
  `ban_reason` varchar(200) DEFAULT NULL COMMENT '封禁原因',
  `ban_expire_time` datetime DEFAULT NULL COMMENT '封禁过期时间',
  `post_count` int DEFAULT 0 COMMENT '发帖数',
  `comment_count` int DEFAULT 0 COMMENT '评论数',
  `like_count` int DEFAULT 0 COMMENT '点赞数',
  `collect_count` int DEFAULT 0 COMMENT '收藏数',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户社区状态表';
```

## 三、接口设计

### 3.1 前台用户端接口

#### 3.1.1 帖子相关接口

**1. 帖子列表查询**
```
GET /api/community/posts
```
参数：
- page: 页码 (默认1)
- size: 每页条数 (默认10)
- category: 分类筛选 (可选)
- keyword: 关键字搜索 (可选)

响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "list": [
      {
        "id": 1,
        "title": "帖子标题",
        "content": "帖子内容摘要",
        "category": "技术分享",
        "authorId": 123,
        "authorName": "用户名",
        "viewCount": 100,
        "likeCount": 20,
        "commentCount": 5,
        "collectCount": 10,
        "isTop": true,
        "createTime": "2024-01-01 12:00:00",
        "isLiked": false,
        "isCollected": false
      }
    ]
  }
}
```

**2. 帖子详情**
```
GET /api/community/posts/{id}
```
响应：
```json
{
  "code": 200,
  "message": "success", 
  "data": {
    "id": 1,
    "title": "帖子标题",
    "content": "完整帖子内容",
    "category": "技术分享",
    "authorId": 123,
    "authorName": "用户名",
    "viewCount": 101,
    "likeCount": 20,
    "commentCount": 5,
    "collectCount": 10,
    "isTop": true,
    "createTime": "2024-01-01 12:00:00",
    "isLiked": false,
    "isCollected": false
  }
}
```

**3. 创建帖子**
```
POST /api/community/posts
```
参数：
```json
{
  "title": "帖子标题",
  "content": "帖子内容",
  "category": "技术分享"
}
```

**4. 点赞帖子**
```
POST /api/community/posts/{id}/like
```

**5. 取消点赞帖子**
```
DELETE /api/community/posts/{id}/like
```

**6. 收藏帖子**
```
POST /api/community/posts/{id}/collect
```

**7. 取消收藏帖子**
```
DELETE /api/community/posts/{id}/collect
```

#### 3.1.2 评论相关接口

**1. 评论列表**
```
GET /api/community/posts/{postId}/comments
```
参数：
- page: 页码 (默认1)
- size: 每页条数 (默认10)
- sort: 排序方式 (time/hot，默认time)

**2. 发表评论**
```
POST /api/community/posts/{postId}/comments
```
参数：
```json
{
  "content": "评论内容",
  "parentId": 0
}
```

**3. 点赞评论**
```
POST /api/community/comments/{id}/like
```

**4. 取消点赞评论**
```
DELETE /api/community/comments/{id}/like
```

#### 3.1.3 个人中心接口

**1. 我的收藏列表**
```
GET /api/community/user/collections
```

**2. 我的评论列表**
```
GET /api/community/user/comments
```

**3. 我的发帖列表**
```
GET /api/community/user/posts
```

### 3.2 后台管理端接口

#### 3.2.1 帖子管理

**1. 帖子列表（管理端）**

```
GET /api/admin/community/posts
```
参数：
- page: 页码
- size: 每页条数
- status: 状态筛选
- authorName: 作者筛选
- startTime: 开始时间
- endTime: 结束时间

**2. 置顶帖子**
```
PUT /api/admin/community/posts/{id}/top
```
参数：
```json
{
  "duration": 24
}
```

**3. 取消置顶**
```
DELETE /api/admin/community/posts/{id}/top
```

**4. 下架帖子**
```
PUT /api/admin/community/posts/{id}/disable
```

**5. 删除帖子**
```
DELETE /api/admin/community/posts/{id}
```

#### 3.2.2 评论管理

**1. 评论列表（管理端）**
```
GET /api/admin/community/comments
```

**2. 删除评论**
```
DELETE /api/admin/community/comments/{id}
```

#### 3.2.3 用户管理

**1. 用户社区状态列表**
```
GET /api/admin/community/users
```

**2. 封禁用户**
```
PUT /api/admin/community/users/{userId}/ban
```
参数：
```json
{
  "reason": "违规原因",
  "duration": 24
}
```

**3. 解封用户**
```
DELETE /api/admin/community/users/{userId}/ban
```

**4. 用户发帖记录**
```
GET /api/admin/community/users/{userId}/posts
```

**5. 用户评论记录**
```
GET /api/admin/community/users/{userId}/comments
```

## 四、核心领域模型

### 4.1 实体类设计

**CommunityPost.java**
```java
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
private Date createTime;

@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8") 
private Date updateTime;

@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
private Date topExpireTime;
```

### 4.2 DTO设计

**前台响应DTO**
- CommunityPostResponse: 帖子响应
- CommunityCommentResponse: 评论响应
- UserCollectionResponse: 用户收藏响应

**后台管理DTO**
- AdminPostQueryRequest: 帖子查询请求
- AdminCommentQueryRequest: 评论查询请求
- UserBanRequest: 用户封禁请求

## 五、实现要点

### 5.1 用户信息获取
```java
@Autowired
private UserContextUtil userContextUtil;

// 获取当前用户信息
UserContextUtil.UserInfo currentUser = userContextUtil.getCurrentUser();
Long userId = currentUser.getId();
String userName = currentUser.getUsername();
```

### 5.2 权限控制
- 普通用户：使用 `userContextUtil.getCurrentUser()` 
- 管理员：使用 `@RequireAdmin` 注解 + `AdminContextUtil`

### 5.3 数据统计更新
- 使用 MyBatis 批量更新优化性能
- 点赞/收藏数通过触发器或定时任务同步

### 5.4 分页查询
```java
// 使用统一的分页工具
return PageHelper.doPage(request, () -> 
    communityPostMapper.selectPostList(request)
);
```

### 5.5 对象转换
```java
// 使用 Hutool BeanUtil 进行对象转换
CommunityPostResponse response = BeanUtil.copyProperties(post, CommunityPostResponse.class);
```

